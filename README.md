# MAX! to MQTT Bridge

A Go-based bridge connecting a CUL-USB stick (868MHz MAX! protocol) to Home Assistant via MQTT.
Designed to replace legacy FHEM installations with a lightweight, standalone service.

## Features

-   **Serial Communication**: Reads `Z` telegrams from CUL-FW compatible sticks.
-   **MAX! Protocol Parsing**: Decodes Temperature, Mode, and Battery State.
    -   **Detailed Support**:
            -   **Thermostat Status**:
                -   **Accepted**: Wall Thermostats (Type `0x70`, `0x42`) and extended Acks (Type `0x02` w/ Actual Temp).
                -   **Ignored**: Radiator Thermostats (Type `0x60`) and standard Acks to prevent duplicate/partial data.
            -   **Payload**: Mode, Setpoint, and Actual Temperature.
-   **Home Assistant Integration**:
    -   **Auto-Discovery**: Fully compliant with HA MQTT Discovery (Climate, Select, Binary Sensor).
    -   **Entities**:
        -   **Climate**: Thermostat control with support for `temperature` (setpoint), `current_temperature` (actual), and `hvac_action` (heating/idle status).
        -   **Select**: Dedicated "Mode" selector (Auto/Manual/Boost/Vacation).
        -   **Sensors**: Battery (Binary OK/Low).
    -   **Pairing Mode**: Trigger via MQTT (`max/bridge/pair`) to pair new devices.
-   **Duty Cycle Management**: 
    -   Adheres to 868MHz 1% transmission limits using CUL's credit system.
    -   Before each TX: queries CUL credits and queue status (`X` command).
    -   Only transmits if queue is empty (0) and credits >= minimum threshold.
    -   Restores MQTT state and logs event if TX is blocked due to duty cycle limits.
-   **Lightweight**: Static binary built with Go, running in a minimal Alpine container.

## Protocol Details

This bridge implements a strict filter to ensure high-quality data and avoid state conflicts in rooms with multiple devices.

### Supported Message Types

-   **Wall Thermostat State (`0x70`)**:
    -   **Description**: The primary status message from Wall Mounted Thermostats.
    -   **Why**: Contains the authoritative Mode, Valid Setpoint, and Battery status for the room.
-   **Wall Thermostat Control (`0x42`)**:
    -   **Description**: Sent when adjustments are made directly on the device (e.g., turning the wheel).
    -   **Why**: Provides immediate feedback on manual changes.
-   **Extended Acknowledgements (`0x02`)**:
    -   **Description**: Acks with a payload length $\ge$ 6 bytes.
    -   **Why**: These are special packets sent by Wall Thermostats that contain the **Actual Temperature** (Current Room Temp). This is the only reliable source for this data in the CUL protocol, so we dynamically detect and parse it.
-   **Radiator Thermostat State (`0x60`)**:
    -   **Description**: Periodic status updates from radiator valves.
    -   **Why**: Accepted to monitor **Battery State** and confirm receipt of commands sent directly to valves.


### Ignored Message Types

-   **Standard Acknowledgements (`0x02`)**:
    -   **Description**: Short Acks (< 6 bytes).
    -   **Reason**: Contain redundant info (Mode/Setpoint) already captured by `0x70` messages. Ignored to reduce MQTT noise.
-   **Shutter Contacts (`0x30`)** & **Time Info (`0x03`)**:
    -   **Reason**: Out of scope for this climate-focused bridge.

## Deployment

### Option A: Home Assistant Add-on

1.  Copy this directory to your Home Assistant `addons/local/max2mqtt` folder.
2.  Navigate to **Settings -> Add-ons -> Add-on Store -> Local** in Home Assistant.
3.  Install **MAX! to MQTT Bridge**.
4.  Configure the Serial Port and MQTT credentials in the "Configuration" tab.
5.  Start the Add-on.

### Option B: Standalone Docker

```bash
# Build the image
docker build -t max2mqtt .

# Run the container
docker run -d \
  --device=/dev/ttyACM0 \
  -e MQTT_BROKER=tcp://192.168.1.10:1883 \
  -e SERIAL_PORT=/dev/ttyACM0 \
  max2mqtt
```

## Configuration Options

| Environment Variable | JSON Option | Default | Description |
|---------------------|-------------|---------|-------------|
| `SERIAL_PORT` | `serial_port` | `/dev/ttyACM0` | Path to CUL stick |
| `BAUD_RATE` | `baud_rate` | `38400` | Serial baud rate |
| `MQTT_BROKER` | `mqtt_broker` | `tcp://homeassistant:1883` | MQTT Broker URL |
| `MQTT_USER` | `mqtt_user` | (empty) | MQTT Username |
| `MQTT_PASS` | `mqtt_pass` | (empty) | MQTT Password |
| `GATEWAY_ID` | `gateway_id` | `123456` | Gateway Hex ID (3 bytes) |
| `LOG_LEVEL` | `log_level` | `info` | Log verbosity (debug/info) |
| `DUTY_CYCLE_MIN_CREDITS` | `duty_cycle_min_credits` | `100` | Min credits to allow sending |
| `COMMAND_TIMEOUT` | `command_timeout` | `5m` | Timeout for queued commands |

> **Note on Configuration:**
> *   **Home Assistant Add-on:** The application automatically reads configuration from `/data/options.json`. This file is generated by the Home Assistant Supervisor at runtime based on the values defined in `config.yaml`.
> *   **Standalone / Docker:** Configuration via Environment Variables takes precedence if `/data/options.json` is not found.

## Finding your Serial Port

On Linux, it is recommended to use the persistent `by-id` path so the device remains found even after reboots or unplugging.

Run this command:
```bash
ls -l /dev/serial/by-id/
```

You should see something like:
`usb-busware.de_CUL868-if00 -> ../../ttyACM0`
Or for a Nano CUL:
`usb-SHK_NANO_CUL_868-if00-port0 -> ../../ttyUSB0`

Use the full path in your config:
`/dev/serial/by-id/usb-SHK_NANO_CUL_868-if00-port0`

## Pairing New Devices

To pair a new MAX! device:
1.  Put the device in pairing mode (usually by holding the boost button).
2.  Send a message to `max/bridge/pair` (payload ignored).
    ```bash
    mosquitto_pub -h homeassistant -t max/bridge/pair -m "on"
    ```
3.  The bridge will respond to pairing requests for 60 seconds.


## Development

The project is written in Go. To build locally:

```bash
go mod download
go build -o max2mqtt .
```

### Cross-Compilation for Linux

If you are building on macOS/Windows for a Linux host (e.g., Raspberry Pi or Debian Server):

**For Standard Linux (AMD64/x86_64):**
```bash
CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-w -s" -o max2mqtt-linux-amd64 .
```

**For Raspberry Pi 3/4/5 (64-bit ARM / aarch64):**
```bash
CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -ldflags="-w -s" -o max2mqtt-linux-arm64 .
```

**For Older Raspberry Pi / 32-bit OS (ARMv7 / armv7l):**
```bash
CGO_ENABLED=0 GOOS=linux GOARCH=arm GOARM=7 go build -ldflags="-w -s" -o max2mqtt-linux-armv7 .
```

## Status

- **Reading/Parsing**: Stable. Validated against real-world data for both Radiator and Wall Thermostats.
- **Writing (Control)**: Implemented. 
  - **Temperature**: Sends Type `0x40` (Manual Mode + Target Temp).
  - **Mode**: Supports Auto, Heat (Manual), Off (Manual 4.5Â°C), and Boost.
  - **Smart Filtering**: Preserves responsiveness by accepting valid ACKs for command confirmation.
- **Duty Cycle**: Pre-TX credit and queue check via 'X' command. TX blocked if queue busy or credits insufficient.

